/**
 * useGitHubExport
 * GitHubã¸ã®ã‚³ãƒ¼ãƒ‰ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã‚’ç®¡ç†ã™ã‚‹ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯
 */
import { useState, useCallback } from 'react';
import { createRepository, addFileToRepo, updateFileInRepo } from '@/services/integrations/GitHubService';
import { getSubjectFinalCode } from '@/utils/storage/codeStorage';
import { isGitHubConnected, getGitHubUser, type GitHubUser } from '@/utils/storage/githubStorage';

interface ExportConfig {
  repoName: string;
  description: string;
  isPrivate: boolean;
}

interface ExportResult {
  url: string;
}

interface UseGitHubExportReturn {
  githubUser: GitHubUser | null;
  isConnected: boolean;
  hasCode: boolean;
  loading: boolean;
  error: string | null;
  success: ExportResult | null;
  exportToGitHub: (config: ExportConfig) => Promise<void>;
  resetState: () => void;
}

const delay = (ms: number) => new Promise(resolve => setTimeout(resolve, ms));

const generateReadme = (subjectTitle: string): string => {
  return `# ${subjectTitle}

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ [Pathly](https://frontend-prod-xi.vercel.app) ã§å­¦ç¿’ã—ãŸå†…å®¹ã§ã™ã€‚

## ðŸ“ ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

\`\`\`
index.html  - HTML
style.css   - CSS
script.js   - JavaScript
\`\`\`

## ðŸš€ ä½¿ã„æ–¹

\`index.html\` ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã„ã¦ãã ã•ã„ã€‚

## ðŸ“… ä½œæˆæ—¥

${new Date().toLocaleDateString('ja-JP')}

---

*Generated by Pathly - ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°å­¦ç¿’ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ *
`;
};

export const useGitHubExport = (
  subjectId: number,
  subjectTitle: string
): UseGitHubExportReturn => {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [success, setSuccess] = useState<ExportResult | null>(null);

  const githubUser = getGitHubUser();
  const isConnected = isGitHubConnected();
  const finalCode = getSubjectFinalCode(subjectId);
  const hasCode = finalCode !== null;

  const resetState = useCallback(() => {
    setLoading(false);
    setError(null);
    setSuccess(null);
  }, []);

  const exportToGitHub = useCallback(
    async (config: ExportConfig) => {
      if (!isConnected || !githubUser) {
        setError('GitHubã¨é€£æºã—ã¦ãã ã•ã„');
        return;
      }

      if (!finalCode) {
        setError('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ãã ã•ã„ã€‚');
        return;
      }

      setLoading(true);
      setError(null);

      try {
        // ãƒªãƒã‚¸ãƒˆãƒªã‚’ä½œæˆ
        const repo = await createRepository({
          name: config.repoName,
          description: config.description,
          isPrivate: config.isPrivate,
        });

        // GitHub APIã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–
        await delay(1500);

        // READMEã‚’æ›´æ–°
        const readmeContent = generateReadme(subjectTitle);
        await updateFileInRepo(githubUser.login, config.repoName, {
          path: 'README.md',
          content: readmeContent,
        });

        // å„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ 
        if (finalCode.html) {
          await addFileToRepo(githubUser.login, config.repoName, {
            path: 'index.html',
            content: finalCode.html,
          });
        }
        if (finalCode.css) {
          await addFileToRepo(githubUser.login, config.repoName, {
            path: 'style.css',
            content: finalCode.css,
          });
        }
        if (finalCode.js) {
          await addFileToRepo(githubUser.login, config.repoName, {
            path: 'script.js',
            content: finalCode.js,
          });
        }

        setSuccess({ url: repo.html_url });
      } catch (err) {
        console.error('Export error:', err);
        setError(err instanceof Error ? err.message : 'ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
      } finally {
        setLoading(false);
      }
    },
    [isConnected, githubUser, finalCode, subjectTitle]
  );

  return {
    githubUser,
    isConnected,
    hasCode,
    loading,
    error,
    success,
    exportToGitHub,
    resetState,
  };
};

/**
 * ãƒªãƒã‚¸ãƒˆãƒªåã‚’æ—¥ä»˜ãƒ™ãƒ¼ã‚¹ã§ç”Ÿæˆ
 */
export const generateRepoName = (): string => {
  const now = new Date();
  const date = now.toISOString().slice(0, 10).replace(/-/g, '');
  return `pathly-project-${date}`;
};